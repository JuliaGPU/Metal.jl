<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Kernel programming · Metal.jl</title><meta name="title" content="Kernel programming · Metal.jl"/><meta property="og:title" content="Kernel programming · Metal.jl"/><meta property="twitter:title" content="Kernel programming · Metal.jl"/><meta name="description" content="Documentation for Metal.jl."/><meta property="og:description" content="Documentation for Metal.jl."/><meta property="twitter:description" content="Documentation for Metal.jl."/><meta property="og:url" content="https://metal.juliagpu.org/stable/usage/kernel/"/><meta property="twitter:url" content="https://metal.juliagpu.org/stable/usage/kernel/"/><link rel="canonical" href="https://metal.juliagpu.org/stable/usage/kernel/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Metal.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Metal.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Usage</span><ul><li><a class="tocitem" href="../overview/">Overview</a></li><li><a class="tocitem" href="../array/">Array programming</a></li><li class="is-active"><a class="tocitem" href>Kernel programming</a><ul class="internal"><li><a class="tocitem" href="#Other-Helpful-Links"><span>Other Helpful Links</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../profiling/">Profiling</a></li><li><span class="tocitem">API reference</span><ul><li><a class="tocitem" href="../../api/essentials/">Essentials</a></li><li><a class="tocitem" href="../../api/compiler/">Compiler</a></li><li><a class="tocitem" href="../../api/kernel/">Kernel programming</a></li><li><a class="tocitem" href="../../api/array/">Array programming</a></li><li><a class="tocitem" href="../../api/mps/">Metal Performance Shaders</a></li></ul></li><li><span class="tocitem">FAQ</span><ul><li><a class="tocitem" href="../../faq/faq/">Frequently Asked Questions</a></li><li><a class="tocitem" href="../../faq/contributing/">Contributing</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Usage</a></li><li class="is-active"><a href>Kernel programming</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Kernel programming</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaGPU/Metal.jl/blob/main/docs/src/usage/kernel.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Kernel-programming"><a class="docs-heading-anchor" href="#Kernel-programming">Kernel programming</a><a id="Kernel-programming-1"></a><a class="docs-heading-anchor-permalink" href="#Kernel-programming" title="Permalink"></a></h1><p>Metal.jl is based off of Apple&#39;s <a href="https://developer.apple.com/metal/Metal-Shading-Language-Specification.pdf">Metal Shading Language (MSL)</a> and Metal framework. The interface allows you to utilize the graphics and computing power of Mac GPUs. Like many other GPU frameworks, its history is rooted in graphics processing but has found use in computing/general purpose GPU (GPGPU) applications.</p><p>The most fundamental idea of programming GPUs (when compared to serial CPU programming) is its <em>parallelism</em>. A GPU function (kernel), when called, is not just ran once in isolation. Rather, numerous (often thousands to millions) psuedo-independent instances (called threads) of the kernel are executed in parallel. These threads are arranged in a hierarchy that allows for varying levels of synchronization. For Metal, the hierarchy is as follows:</p><ul><li>Thread: A single execution unit of the kernel</li><li>Threadgroup: A collection of threads that share a common block of memory and synchronization</li></ul><p>barriers</p><ul><li>Grid: A collection of threadgroups</li></ul><p>The threadgroup and grid sizes are set by the user when launching the GPU kernel. There are upper limits determined by the targeted hardware, and the sizes can be 1, 2, or 3-dimensional. For Metal.jl, these sizes are set using the <code>@metal</code> macro&#39;s keyword arguments. The <code>grid</code> keyword determines the grid size while the <code>threads</code> keyword determines the threadgroup size.</p><p>For example, given a 10x10x3 image that you want to run a function independently on each pixel, the kernel launch code might look like the following: <code>@metal threads=(10,10) groups=3 my_kernel(gpu_image_array)</code> This would launch 3 separate threadgroups of 100 threads each (10 in the first dimension and 10 in the second dimension)</p><p>There is also additional hierarchy layers that consists of small groups of threads that execute in lockstep called <em>waves/SIMD groups/</em>wavefronts* and <em>quadgroups</em>. However, the basic three-tier hierarchy is enough to get started.</p><p><a href="https://developer.apple.com/documentation/metal/compute_passes/creating_threads_and_threadgroups?language=objc">Here</a> is a helpful link with good visualizations of Metal&#39;s thread hierarchy (also covering SIMD groups).</p><p>Each thread has its own set of private variables. Most importantly, each thread has associated unique indices to identify itself within its threadgroup and grid. These are traditionally what are used to differentiate execution across threads. You can also query what the grid and threadgroup sizes are as well.</p><p>For Metal.jl, these values are accessed via the following functions:</p><ul><li><code>thread_index_in_threadgroup()</code></li><li><code>grid_size_Xd()</code></li><li><code>thread_position_in_grid_Xd()</code></li><li><code>thread_position_in_threadgroup_Xd()</code></li><li><code>threadgroup_position_in_grid_Xd()</code></li><li><code>threadgroups_per_grid_Xd()</code></li><li><code>threads_per_grid_Xd()</code></li><li><code>threads_per_threadgroup_Xd()</code></li></ul><p><em>Where &#39;X&#39; is 1, 2, or 3 according to the number of dimensions requested.</em></p><p>Using these in a kernel (taken directly from the <a href="https://github.com/JuliaGPU/Metal.jl/blob/main/examples/vadd.jl">vadd example</a>):</p><pre><code class="language-julia hljs">function vadd(a, b, c)
    i = thread_position_in_grid_1d()
    c[i] = a[i] + b[i]
    return
end</code></pre><p>This kernel takes in three vectors (a,b,c) all of the same length and stores the element-wise sum of <code>a</code> and <code>b</code> into <code>c</code>. Each thread in this kernel gets its unique position in the grid (arrangement of all threadgroups) and stores this value into the variable <code>i</code> which is then used as the index into the vectors. Thus, each thread is computing one sum and storing the result in the output vector.</p><p>To ensure this kernel functions properly, we have to launch it with exactly as many threads as the length of the vectors. If we under or over-launch threads, the result could be incorrect.</p><p>An example of a good launch:</p><pre><code class="language-julia hljs">len = prod(size(d_a))
@metal threads=len vadd(d_a, d_b, d_c)</code></pre><p>Additional notes:</p><ul><li>Kernels must always return nothing</li><li>Kernels are asynchronous. To synchronize, use the <code>Metal.@sync</code> macro.</li></ul><h2 id="Other-Helpful-Links"><a class="docs-heading-anchor" href="#Other-Helpful-Links">Other Helpful Links</a><a id="Other-Helpful-Links-1"></a><a class="docs-heading-anchor-permalink" href="#Other-Helpful-Links" title="Permalink"></a></h2><p><a href="https://developer.apple.com/metal/Metal-Shading-Language-Specification.pdf">Metal Shading Language Specification</a></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../array/">« Array programming</a><a class="docs-footer-nextpage" href="../../profiling/">Profiling »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.5.0 on <span class="colophon-date" title="Thursday 10 October 2024 10:15">Thursday 10 October 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
